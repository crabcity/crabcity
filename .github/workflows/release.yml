name: Release

on:
  push:
    tags: ["v*"]

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - target: linux-x86_64
            runner: ubuntu-latest
            bazel_args: "--platforms=//bazel/config/platform/rust:linux_x86_64"
            asset: crab-linux-x86_64
          - target: macos-aarch64
            runner: macos-latest
            bazel_args: ""
            asset: crab-macos-aarch64

    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4

      - name: Cache Bazel repository cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/bazel-repo-cache
          key: bazel-repo-${{ matrix.target }}-${{ hashFiles('MODULE.bazel') }}
          restore-keys: |
            bazel-repo-${{ matrix.target }}-

      - name: Cache Bazel disk cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/bazel-disk-cache
          key: bazel-disk-${{ matrix.target }}-${{ hashFiles('MODULE.bazel', 'Cargo.lock', 'packages/crab_city_ui/pnpm-lock.yaml') }}
          restore-keys: |
            bazel-disk-${{ matrix.target }}-

      - name: Build
        run: >
          bazel build //packages/crab_city:crab_embedded
          ${{ matrix.bazel_args }}
          --disk_cache=~/.cache/bazel-disk-cache
          --repository_cache=~/.cache/bazel-repo-cache

      - name: Prepare artifact
        run: cp bazel-bin/packages/crab_city/crab_embedded ${{ matrix.asset }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset }}
          path: ${{ matrix.asset }}

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release
          for dir in artifacts/crab-*/; do
            name=$(basename "$dir")
            cp "$dir/$name" "release/$name"
          done
          cp scripts/install.sh release/install.sh
          cd release
          sha256sum crab-* install.sh > checksums-sha256.txt

      - name: Determine prerelease
        id: meta
        run: |
          TAG="${GITHUB_REF_NAME}"
          if [[ "$TAG" == *-* ]]; then
            echo "prerelease=true" >> "$GITHUB_OUTPUT"
          else
            echo "prerelease=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          prerelease: ${{ steps.meta.outputs.prerelease }}
          generate_release_notes: true
          files: release/*
          body: |
            ## Install

            ```sh
            curl -fsSL https://github.com/crabcity/crabcity/releases/latest/download/install.sh | bash
            ```

            Or install a specific version:

            ```sh
            curl -fsSL https://github.com/crabcity/crabcity/releases/latest/download/install.sh | bash -s -- --version ${{ github.ref_name }}
            ```

            ## Downloads

            | Platform | Binary |
            |----------|--------|
            | Linux x86_64 | [`crab-linux-x86_64`](https://github.com/crabcity/crabcity/releases/download/${{ github.ref_name }}/crab-linux-x86_64) |
            | macOS (Apple Silicon) | [`crab-macos-aarch64`](https://github.com/crabcity/crabcity/releases/download/${{ github.ref_name }}/crab-macos-aarch64) |

            ## Manual install

            ```sh
            # Download the binary for your platform (adjust the asset name as needed)
            # Linux x86_64:       crab-linux-x86_64
            # macOS Apple Silicon: crab-macos-aarch64
            curl -fsSL https://github.com/crabcity/crabcity/releases/download/${{ github.ref_name }}/crab-PLATFORM -o crab
            chmod +x crab
            mv crab ~/.local/bin/crab
            ```

            ## SHA256 Checksums

            ```
            $(cat release/checksums-sha256.txt)
            ```
